<!doctype html>
<html class="no-js" lang="zh-cn">
<head>
    <title>签约用户</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/afterConsultation.css">
    <link rel="stylesheet" href="css/quick_consulting.css">
    <script src="js/modernizr-2.8.3.min.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/config.js"></script>
    <script src="js/sha1.js"></script>
    <script src="js/quick_consulting.js"></script>
    <style>
        .package_item{
            overflow: hidden;
            padding: 0 15px;
            height: 50px;
            line-height: 50px;
            position: relative;
        }
        .package_item.choose_item{
            background: #e8e8e8;
        }
        #searchbox2{
            margin-bottom: -12px;
            width: 100%;
            height: 50px;
            text-align: center;
        }
        #searchbox2 .searchf{
            width: 86%;
            margin: 15px 0 0 7%;
            height: 35px;
            border: 1px solid #ccc;
            text-indent: 14px;
            color: #666;
            border-radius: 20px;
            overflow: hidden;
        }
        #searchbox2 input{
            width: 76%;
            float: left;
            border: none;
            border-radius: 20px;
            line-height: 16px;
            padding:10px 0 9px 4%;
            background: #ffffff;
            text-indent: 8%
        }
        #search {
            display: inline-block;
            width: 14%;
            float: right;
            height: 35px;
            margin-right: 5px;
        }
        #search {
            display: inline-block;
            width: 17%;
            float: right;
            height: 35px;
            background: url("images/menuicon/search.png")no-repeat center;
            background-size: 20px;
        }
        .other_information{
            width: 64%;
            float: left;
            display: inline-block;
        }
        .phone{
            float: right;
            display: inline-block;
        }
        .other_information>span{
            display: inline-block;
            margin-right: 3%;
            text-align: center;
        }
        .baby_name{
            width: 28%;
        }
        .baby_sex{
            width: 12%;
        }
        .baby_age{
            width: 42%;
        }
        #cover{
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 2000;
            top: 0;
            left: 0;
            background: rgba(0,0,0,.4);
        }
        #cover>div{
            /*width: 30%;*/
            position: absolute;
            line-height: 40px;
            background: white;
            text-align: center;
            top: 50%;
            left: 50%;
            margin-left: -15%;
            margin-top: -15%;
        }
        #cover>div>div:nth-child(1){
            padding: 8px 12px;
            border-bottom: 1px solid #e8e8e8;
        }
        .overdue_div{
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1;
            opacity: .5;
            height: 100%;
        }
        #more{
            display: inline-block;
            width: 15%;
            height: 50px;
            float: left;
            background: url("images/consulting/more.png") no-repeat center center;
            background-size: 22px;
        }
        #showBusiness{
            position: fixed;
            left: 0;
            bottom: 0;
            background: #f0f0f0;
            width: 100%;
        }
        #showBusiness ul{
            overflow: hidden;
            padding: 0 15px;
        }
        #showBusiness ul li{
            width: 25%;
            float: left;
            padding: 5px 0;
            text-align: center;
            font-size: 12px;
            line-height: 26px;
        }
        #showBusiness ul li img{
            width: 40px;
        }
        #sendImg{
            display: block;
            width: 40px;
            height: 40px;
            position: relative;
            top: -40px;
            opacity: 0;
            z-index: 2;
        }
        #beforeConsultation{
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2111;
            background: white;
        }
        #headerL {
            width: 100%;
            height: 45px;
            background: #1cba93;
            text-align: center;
            position: fixed;
            top: 0;
            z-index: 999;
            color: white;
        }

        #headerL .header-left {
            width: 20%;
            float: left;
            line-height: 45px;
            font-size: 30px;
            height: 45px;
        }

        #headerL .header-left div, #header .headerLeft div{
            background: url("images/normalicon/return.png") no-repeat center center;
            background-size: 18px;
            height: 45px;
        }

        #headerL .header-center {
            width: 60%;
            float: left;
            line-height: 45px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            font-size: 16px;
        }

        #headerL .header-right {
            width: 20%;
            float: right;
            line-height: 45px;
            height: 45px;
        }
    </style>
</head>
<body>

<div id="header" class="doctor_header">
    <div class="header-left"><p></p></div>
    <div class="header-center">签约用户</div>
    <div class="header-right"></div>
</div>
<!--header-->

<div id="container">
    <div id="searchbox2">
        <div class="searchf">
            <input placeholder="宝宝姓名" type="text"/>
            <span id="search" onclick="searchMessage()"></span>
        </div>
    </div>
    <!--<div class="package_item">-->
        <!--<div class="other_information">-->
            <!--<span class="baby_name">王宝宝</span>-->
            <!--<span class="baby_sex">女</span>-->
            <!--<span class="baby_age">14个月</span>-->
        <!--</div>-->
        <!--<div class="phone">13460334652</div>-->
    <!--</div>-->
    <!--<p class="gray_3"></p>-->
    <div id="package"></div>
    <div id="cover" style="display: none">
        <div>
        </div>
    </div>
</div>
<!--container-->
<div id="beforeConsultation" style="display: none">
    <div id="headerL">
        <div class="header-left" onclick="$('#beforeConsultation').hide();"><div></div></div>
        <div class="header-center">开始会话</div>
        <div class="header-right look"></div>
    </div>
    <footer class="fix">
        <div class="before" style="display: none">
            <img src="images/zxq_15.png" style="visibility:hidden" alt="语音" id="audio">
        </div>
        <div id="more" onclick="showBusiness(this)" class="focus"></div>
        <div class="con">
            <div id="msgText" contenteditable="true"></div>
        </div>
        <div class="after" onclick="sendMsg('1',$('#msgText').html())">发送
            <!--<img src="images/zxq_18.png" alt="加">-->
        </div>
    </footer>
    <div id="showBusiness" style="display: none">
        <ul>
            <li>
                <form id="updateImg" action="" method="post" enctype="multipart/form-data" style="height: 40px">
                    <img src="images/consulting/sendimg.png" alt=""/>
                    <canvas id="myCanvas" style="display:none;border-radius:50%" width="40" height="40"></canvas>
                    <input type="file" id="sendImg" accept="image/*" name="updateMyHeadFileElem" onchange="loadImage(this)" />
                </form>
                <p>图片</p>
            </li>
            <li onclick="buildBusiness('family_doctor_patient.html','儿科门诊预约')">
                <div><img src="images/consulting/babypatient.png" alt=""/></div>
                <p>儿科门诊</p>
            </li>
            <li onclick="buildBusiness('family_doctor_erbao.html','儿保门诊预约')">
                <div><img src="images/consulting/babypoint.png" alt=""/></div>
                <p>儿保门诊</p>
            </li>
            <li onclick="buildBusiness('family_doctor_vaccine.html','计免预约')">
                <div><img src="images/consulting/vaccine.png" alt=""/></div>
                <p>计免</p>
            </li>
            <li onclick="layer_according()">
                <div><img src="images/consulting/fast_reply.png" alt=""/></div>
                <p>快捷回复</p>
            </li>
        </ul>
    </div>
</div>
<!--footer-->
<div id="reply_layer">
    <div id="reply_layer_header">
        <div class="header-lefts"><p></p></div>
        <div class="header-center">快捷回复</div>
        <div class="header-right"></div>
    </div>
    <div id="reply_layer_content">
        <p id="title">选择一条进行回复</p>
        <p id="title1">长按内容即可进行编辑、删除等操作</p>
        <p class="gray_3"></p>
        <ul id="message_list">
            <!--<li class="message_li">-->
            <!--<p class="message_content">1.您好，我是康宝宝</p>-->
            <!--<p class="message_operation"><span class="editor">编辑</span><span>|</span><span class="del">删除</span></p>-->
            <!--</li>-->
        </ul>
        <div id="reply_mask">
            <div id="mask_layer">
                <div id="mask_layer_content">
                    <div contenteditable="true"></div>
                </div>
                <p class="gray_3"></p>
                <div id="mask_layer_button">
                    <div id="cancel" onclick="cancel()">取消</div>
                    <div class="select" id="determine" onclick="determine()">确定</div>
                </div>
            </div>
        </div>
    </div>
    <div id="bottom">
        <p class="button_01">+ 添加快捷回复</p>
    </div>
</div>


<script src="js/plugins.js"></script>
<script>
    var userId;
    function showBusiness(div){//更多发送内容
        var cla=$(div).prop('class');
        if(cla=='focus'){
            $(div).prop('class','blur');
            $('footer').css({bottom:'153px'});
            $('#msgText').blur();
            $('#showBusiness').show();
        }else if(cla=='blur'){
            $(div).prop('class','focus');
            $('#msgText').focus();
            $('footer').css({bottom:'0'});
            $('#showBusiness').hide();
        }
    }
    function buildBusiness(type,con){//发送链接
        var str=type+'?'+package_id;
        $.ajax({
            type: 'post',
            async: false,
            url: urlWay.fdmanage + 'fdUserManage.action',
            data: {action: "replaysFirst", "consult.fdServicePackage.id": package_id, doctorReply: str,'userInfo.id':userId},
            success: function (result) {
                window.location.href='afterConsultation.html?'+result.consult.logId+'&'+package_id+'&N';
            }
        });
    }
    // 参数，最大高度
    var MAX_HEIGHT = 500;
    // 渲染
    function render(src){
        var image = new Image();
        image.onload = function(){
            var canvas = document.getElementById("myCanvas");
            var x = image.width;
            var y = image.height;

            if(image.height > MAX_HEIGHT) {
                // 宽度等比例缩放 *=
                image.width *= MAX_HEIGHT / image.height;
                image.height = MAX_HEIGHT;
            }
            var ctx = canvas.getContext("2d");  // 获取 canvas的 2d 环境对象,可以理解Context是管理员，canvas是房子
            ctx.clearRect(0, 0, canvas.width, canvas.height);// canvas清屏
//      canvas.width = image.width;  // 重置canvas宽高
//      canvas.height = image.height;
            canvas.width = image.width;  // 重置canvas宽高
            canvas.height = image.height;

            ctx.drawImage(image, 0, 0,x,y,0,0,image.width,image.height);  // 将图像绘制到canvas上
        };
        image.src = src;  // 记住必须先绑定事件，才能设置src属性，否则会出同步问题。
        setTimeout(function(){
            sendImage();
        },2000);
    };
    // 加载 图像文件(url路径)
    function loadImage(obj){
        var src = $(obj).get(0).files[0];
        var imgType = src.name.split('.');
        imgType = imgType[imgType.length-1];//返回后缀名，以兼容部分移动端浏览器
        if(imgType == 'jpg'){
            imgType = 'jpeg';
        }
        if(!(imgType == 'jpeg' || imgType == 'png' || imgType == 'gif')){
            ale('请选择图片文件');
            return false;
        }

        // 创建 FileReader 对象 并调用 render 函数来完成渲染.
        var reader = new FileReader();
        // 绑定load事件自动回调函数
        var imgData = '';
        reader.onload = function(e){
            if(e.target.result.substring(5,10) != 'image'){
                var imgDataArr = e.target.result.split('base64');
                imgData = imgDataArr[0] + "image/"+imgType+";base64"+imgDataArr[1];
                render(imgData);
            }else{
                render(e.target.result);
            }
        };
        // 读取文件内容
        reader.readAsDataURL(src);
    };
    //---------------------------------------------
    // 上传图片，jQuery版
    function sendImage(){
        var canvas = document.getElementById("myCanvas");
        // 获取Base64编码后的图像数据，格式是字符串
        // "data:image/png;base64,"开头,需要在客户端或者服务器端将其去掉，后面的部分可以直接写入文件。
        var dataurl = canvas.toDataURL("image/png");
        // 为安全 对URI进行编码
        // data%3Aimage%2Fpng%3Bbase64%2C 开头
        var imagedata =  encodeURIComponent(dataurl);
        $.ajax({
            type: 'post',
            async: false,
            url: urlWay.fdmanage + 'fdUserManage.action',
            data: {action: "replaysFirst",doctorReply:'', "consult.fdServicePackage.id": package_id, imagedata: imagedata,'userInfo.id':userId},
            success: function (result) {
                window.location.href='afterConsultation.html?'+result.consult.logId+'&'+package_id+'&N';
            }
        });
    };

    function sendMsg(msgType, content){//发普通消息
        if (msgType == "1" && ($("#msgText").html() == "" || $("#msgText").html() == null)) {
//		ale("请输入要发送内容");
        }else {
            $.ajax({
                type: 'post',
                async: false,
                url: urlWay.fdmanage + 'fdUserManage.action',
                data: {action: "replaysFirst", "consult.fdServicePackage.id": package_id, doctorReply: content,'userInfo.id':userId},
                success: function (result) {
                    window.location.href='afterConsultation.html?'+result.consult.logId+'&'+package_id+'&N';
                }
            });
        }
    }
    var package_id = window.location.search.substring(1);
    $(function () {
        $.ajax({//签约用户列表
            type: 'post',
            async: false,
            url: urlWay.fdmanageHost+'fdService.action',
            data: {action: "getUserInfoList","fdServicePackage.id":package_id},
            success: function (result) {
                if(result.userInfoList!=null){
                    for(var i=0;i<result.userInfoList.length;i++){
                        var userInfoList = result.userInfoList[i];
                        var isLate = '';
                        if(userInfoList.fdServicePast!='false'){
                            isLate = '<img class="overdue_div" src="images/consulting/overdue.png" alt=""/>';
                        }
                        $("#package").append('<div class="package_item" data-id="'+userInfoList.id+'" data-userName="'+userInfoList.babyName+'"><div class="other_information"><span class="baby_name">'+userInfoList.babyName+'</span><span class="baby_sex">'+userInfoList.sex+'</span>' +
                        '<span class="baby_age">'+userInfoList.moonSage+'个月</span></div><div class="phone">'+userInfoList.phone+'</div>'+isLate+'</div><p class="gray_3"></p>');
                    }
                }
            }
        });
        $('.package_item').click(function () {//选中签约用户
            $(this).addClass('choose_item').siblings().removeClass('choose_item');
            var id=$(this).attr('data-id');
            $('#cover').show();
            $('#cover>div').html('<div onclick="chooseBusiness(\'health_records.html?'+id+'\',event)">查看健康记录</div> ' +
            '<div onclick="chooseBusiness(\'sendMessage?'+id+'\',event)">发消息</div>');
        });
        $('#cover').click(function () {
            $(this).hide();
        });
       $(".overdue_div").parents(".package_item").css("color","#909090");
        $('#msgText').click(function () {//获取焦点
            $('#more').prop('class','focus');
            $('footer').css({bottom:'0'});
            $('#msgText').focus();
            $('#showBusiness').hide();
        });
    });
    function chooseBusiness(type,e){//选择业务
        e.stopPropagation();
        if(type.indexOf('sendMessage')>-1){
            var useId=type.substring(12);
            $.ajax({
                type: 'post',
                url: urlWay.fdmanage + 'fdUserManage.action',
                cache: false,
                async: false,
                data: {
                    action: "getConsultListAtDoctor",
                    "userInfo.id":useId
                },
                success: function (result) {
                    if (result.mes == '请登录') {
                        ale('请登录', '24px');
                        window.location.href = "login.html";
                    }else if (result.mes == "成功") {
                        window.location.href = "afterConsultation.html?"+result.consult.logId+'&'+result.consult.fdServicePackage.id+'&N';
                    }else if(result.mes=='会话结束'){
                        $('#beforeConsultation').show();
                        userId=useId;
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    layer();
                }
            });
        }else{
            window.location.href=type;
        }
    }
    function searchMessage(){//搜索
        var val=$('#searchbox2 input').val();
        if(val==''){
            $('.package_item').show();
            return false;
        }else{
            var obj=$('.package_item');
            obj.hide();
            var num=0;
            $(obj).each( function () {
                if($(this).attr('data-userName').indexOf(val)>-1){
                    num=1;
                    return false;
                };
            });
            $('.package_item[data-userName*='+val+']').show();
            if(num==0){
                ale('无搜索内容');
                obj.show();
            }
        }
    }
</script>

</body>
</html>
