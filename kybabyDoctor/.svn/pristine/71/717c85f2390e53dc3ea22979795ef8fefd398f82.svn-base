<!doctype html>
<html class="no-js" lang="zh-cn">
<head>
    <title>医生资料</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/Doctorauthentication.css">
    <link rel="stylesheet" href="css/org_doctorDataManage.css">
    <script src="js/modernizr-2.8.3.min.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/config.js"></script>
    <style>
        .updateImg{
            margin: 8px 10px 0 0;
            width: 40px;
            height: 40px;
            display: inline-block;
            position: relative;
        }
        .hidden{
            display: none;
        }
        form.file .canvas {
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 1;
        }
        form.file .canvas1 {
            display: none;
        }
        form.file {
            width: 40px;
            height: 40px;
        }
        form.file>.h_img{
            margin: 0;
        }
        .file > input {
            opacity: 0;
            filter: alpha(opacity=0);
            width: 40px;
            height: 40px;
            position: absolute;
            left: 0;
            top: 0;
            padding: 0;
        }
        .removeImg{
            position: absolute;
            top: -9px;
            z-index: 10;
            width: 18px;
            height: 18px;
            color: #505050;
            line-height: 18px;
            right: -9px;
            text-align: center;
            border-radius: 100%;
            background: #e8e8e8;
        }
    </style>
</head>
<body>
<!--header-->
<div id="header" class="doctor_header">
    <div class="header-left" onclick="link_to('org_doctorDataMan_begin.html')"><p></p></div>
    <div class="header-center">医生资料</div>
    <div class="header-right" onclick="doctorDataMan.saveOrUpdateDoctorCardInfo();">
        <span class="right_topButton">保存</span>
    </div>
</div>
<div id="container">
    <div>
        <ul class="header_nav flex_cont">
            <li class="flex_item" onclick="link_to('org_doctorDataMan_docInfo_basic.html')">基本信息</li>
            <li class="interval"><span>|</span></li>
            <li class="flex_item header_nav_select">身份提交</li>
            <li class="interval"><span>|</span></li>
            <li class="flex_item" onclick="link_to('org_doctorDataMan_docInfo_life.html')">生活信息</li>
            <li class="interval"><span>|</span></li>
            <li class="flex_item" onclick="link_to('org_doctorDataMan_docInfo_evaluation.html')">评价</li>
        </ul>
    </div>
    <div class="doctor_information">
        <div>
            <div class="information_div flex_cont">
                <label>身份证号：</label>
                <p class="flex_item"><input type="number" id="ID_card" placeholder="身份证号"/></p>
            </div>
            <p class="gray_1"></p>
        </div>
        <div>
            <div class="information_div flex_cont">
                <label>执业证号：</label>
                <p class="flex_item"><input type="number" id="practice_num" placeholder="执业证号"/></p>
            </div>
            <p class="gray_3"></p>
            <div class="information_div_img flex_cont">
                <label>执业证书：</label>
                <div class="flex_item" id="practice_certificate">
                    <div class="updateImg">
                        <form class="file" action="" method="post" enctype="multipart/form-data">
                            <img src="images/menuicon/icon_add.png" class="h_img"/>
                            <canvas width="40" height="40" class="canvas"></canvas>
                            <input type="file" class="input" accept="images/*" onchange="loadImage(this,'执业证书')"/>
                            <canvas class="canvas1"></canvas>
                        </form>
                    </div>
                </div>
            </div>
            <p class="gray_1"></p>
        </div>
        <div>
            <div class="information_div_img flex_cont">
                <label>资格证书：</label>
                <div class="flex_item" id="qualification_certificate">
                    <div class="updateImg">
                        <form class="file" action="" method="post" enctype="multipart/form-data">
                            <img src="images/menuicon/icon_add.png" class="h_img"/>
                            <canvas width="40" height="40" class="canvas"></canvas>
                            <input type="file" class="input" accept="images/*" onchange="loadImage(this,'资格证书')"/>
                            <canvas class="canvas1"></canvas>
                        </form>
                    </div>
                </div>
            </div>
            <p class="gray_1"></p>
        </div>
        <div>
            <div class="information_div_img flex_cont">
                <label>职称证书：</label>
                <div class="flex_item" id="certificate_title">
                    <div class="updateImg">
                        <form class="file" action="" method="post" enctype="multipart/form-data">
                            <img src="images/menuicon/icon_add.png" class="h_img"/>
                            <canvas width="40" height="40" class="canvas"></canvas>
                            <input type="file" class="input" accept="images/*" onchange="loadImage(this,'职称证书')"/>
                            <canvas class="canvas1"></canvas>
                        </form>
                    </div>
                </div>
            </div>
            <p class="gray_1"></p>
        </div>
    </div>
</div>
<script>
    $(function () {

    });
    function loadImage(obj,type) {
        var src = $(obj).get(0).files[0];
        var imgType = src.name.split('.');
        imgType = imgType[imgType.length - 1];//返回后缀名，以兼容部分移动端浏览器
        if (imgType == 'jpg') {
            imgType = 'jpeg';
        }
        if (!(imgType == 'jpeg' || imgType == 'png' || imgType == 'gif')) {
            ale('请选择图片文件');
            return false;
        }

        // 创建 FileReader 对象 并调用 render 函数来完成渲染.
        var reader = new FileReader();
        // 绑定load事件自动回调函数
        var imgData = '';
        reader.onload = function (e) {
            if (e.target.result.substring(5, 10) != 'image') {
                var imgDataArr = e.target.result.split('base64');
                imgData = imgDataArr[0] + "image/" + imgType + ";base64" + imgDataArr[1];
                render(imgData, obj,type);
            } else {
                render(e.target.result, obj,type);
            }
        };
        // 读取文件内容
        reader.readAsDataURL(src);
    }
    var MAX_HEIGHT = 500;
    // 渲染
    function render(src, obj,type) {
        var image = new Image();
        image.onload = function () {
            var canvas = $(obj).prev(".canvas").get(0);
            var canvas1 = $(obj).next(".canvas1").get(0);
            var x = image.width;
            var y = image.height;

            if (image.height > MAX_HEIGHT) {
                // 宽度等比例缩放 *=
                image.width *= MAX_HEIGHT / image.height;
                image.height = MAX_HEIGHT;
            }
            var ctx = canvas.getContext("2d");  // 获取 canvas的 2d 环境对象,可以理解Context是管理员，canvas是房子
            var ctx1 = canvas1.getContext("2d");  // 获取 canvas的 2d 环境对象,可以理解Context是管理员，canvas是房子
            ctx.clearRect(0, 0, canvas.width, canvas.height);// canvas清屏
            ctx1.clearRect(0, 0, canvas1.width, canvas1.height);// canvas清屏
            canvas1.width = image.width;  // 重置canvas宽高
            canvas1.height = image.height;
            ctx.drawImage(image, 0, 0, x, y, 0, 0, 40, 40);  // 将图像绘制到canvas上
            ctx1.drawImage(image, 0, 0, x, y, 0, 0, image.width, image.height);  // 将图像绘制到canvas上
        };
        image.src = src;  // 记住必须先绑定事件，才能设置src属性，否则会出同步问题。
        setTimeout(function () {
            sendImage(obj,type);
        }, 2000);
        $(obj).prev(".canvas").show();
    }
    function sendImage(obj,type) {
        var canvas1 = $(obj).next(".canvas1").get(0);
        // 获取Base64编码后的图像数据，格式是字符串
        // "data:image/png;base64,"开头,需要在客户端或者服务器端将其去掉，后面的部分可以直接写入文件。
        var dataurl = canvas1.toDataURL("image/png");
        // 为安全 对URI进行编码
        // data%3Aimage%2Fpng%3Bbase64%2C 开头
        var imagedata = encodeURIComponent(dataurl);
        doctorDataMan.uploadDoctorImageInfo(imagedata,type,obj);
    }
    var doctorDataMan={
        doctorId:302,
        uploadDoctorImageInfo: function (imagedata,type,obj) {
            //上传医生资格证书图片
            $.ajax({
                type:"post",
                url:urlWay.doctorDataGather+"doctorDataGather.action",
                async:true,
                cache:false,
                data:{
                    action:"uploadDoctorImageInfo",
                    "doctorCardInfo.doctorInfo.id":doctorDataMan.doctorId,
                    "doctorCardInfo.imgBase64":imagedata,
                    "doctorCardInfo.imgType":type
                },
                success: function (result) {
                    if(result.mes=="成功"){
                        $(obj).parent().parent().append('<span class="removeImg" onclick="doctorDataMan.removeDoctorImageInfo('+result.doctorCardInfo.id+',this)">×</span>');
                        var len=$(obj).parent().parent().parent().find('.updateImg').length;
                        var hidden='';
                        if(len>=6){
                            hidden='hidden';//最多六张图片，然后隐藏选择图片按钮
                        }
                        $(obj).parent().parent().parent().append('<div class="updateImg '+hidden+'">' +
                        '<form class="file" action="" method="post" enctype="multipart/form-data"> ' +
                        '<img src="images/menuicon/icon_add.png" class="h_img"/> ' +
                        '<canvas width="40" height="40" class="canvas"></canvas> ' +
                        '<input type="file" class="input" accept="images/*" onchange="loadImage(this,\''+type+'\')"/> ' +
                        '<canvas class="canvas1"></canvas> ' +
                        '</form> </div>');
                    }
                },
                error: function () {

                }
            });
        },
        removeDoctorImageInfo: function (id,obj) {
            $(obj).parent().parent().parent().find('.updateImg').removeClass('hidden');
            //删除医生资格证书图片
            $.ajax({
                type:"post",
                url:urlWay.doctorDataGather+"doctorDataGather.action",
                async:true,
                cache:false,
                data:{
                    action:"removeDoctorImageInfo",
                    "doctorCardInfo.id":id
                },
                success: function (result) {
                    if(result.mes=='成功'){
                        $(obj).parent().remove();
                    }
                },
                error: function () {

                }
            });
        },
        saveOrUpdateDoctorCardInfo: function () {
            var idCardNum=$('#ID_card').val();
            var idCard=$('#practice_num').val();
            //身份提交保存
            $.ajax({
                type:"post",
                url:urlWay.doctorDataGather+"doctorDataGather.action",
                async:true,
                cache:false,
                data:{
                    action:"saveOrUpdateDoctorCardInfo",
                    "doctorInfo.id":doctorDataMan.doctorId,
                    "doctorInfo.idCardNum":idCardNum,
                    "doctorInfo.idCard":idCard
                },
                success: function (result) {
                    if(result.mes=="成功"){
                        ale('身份提交保存成功');
                    }
                },
                error: function () {

                }
            });
        }
    }
</script>
</body>
</html>