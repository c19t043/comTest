package com.kybaby.newbussiness.doctorsign.action;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.apache.struts2.ServletActionContext;

import com.kybaby.domain.DoctorInfo;
import com.kybaby.domain.Position;
import com.kybaby.newbussiness.doctorclinic.domain.DoctorServiceType;
import com.kybaby.newbussiness.doctorclinic.domain.HospitalBasicInfo;
import com.kybaby.newbussiness.doctorring.action.NewBaseAction;
import com.kybaby.newbussiness.doctorring.util.DateManage;
import com.kybaby.newbussiness.doctorsign.domain.DoctorCardInfo;
import com.kybaby.newbussiness.doctorsign.domain.DoctorLifeInfo;
import com.kybaby.newbussiness.doctorsign.domain.DoctorMajor;
import com.kybaby.newbussiness.medicalorgandbusiness.domain.OrganOperator;
import com.kybaby.util.EncryptUtil;
import com.kybaby.util.LogUtil;

@SuppressWarnings("serial")
public class DoctorDataGatherAction extends NewBaseAction{
	
	private String uploadDir = "../kybabyBG/admin/images/doctorCertifiedPicture";// 保存上传文件的目录
	private DoctorInfo doctorInfo;
	private DoctorCardInfo doctorCardInfo;
	private DoctorLifeInfo doctorLifeInfo;
	private HospitalBasicInfo hospitalBasicInfo;
	private List<Position>  positionList;
	private DoctorMajor major;
	private List<DoctorMajor> firstMajors;
	private List<DoctorMajor> secondMajors;
	private List<DoctorMajor> thirdMajors;
	private String mes;
	/**
	 * 服务内容集合
	 */
	private List<DoctorServiceType> doctorServiceTypes;
	/**
	 * 医院信息集合
	 */
	private List<HospitalBasicInfo> hospitalBasicInfoList;
	
	@Override
	public String execute() throws Exception {
		
		/*
		 * 添加or更新医生基础信息
		 */
		if("saveOrUpdateDoctorBasicInfo".equals(action)){
			saveOrUpdateDoctorBasicInfo();
		}
		/*
		 * 添加or更新身份证明
		 */
		else if("saveOrUpdateDoctorCardInfo".equals(action)){
			saveOrUpdateDoctorCardInfo();
		}
		/*
		 * 添加or更新医生评价
		 */
		else if("saveOrUpdateDoctorAppraise".equals(action)){
			saveOrUpdateDoctorAppraise();
		}
		/*
		 * 添加or更新医生生活信息 
		 */
		else if("saveOrUpdateDoctorLifInfo".equals(action)){
			saveOrUpdateDoctorLifInfo();
		}
		/*
		 * 查询医生基本信息 
		 */
		else if("queryDoctorBasicInfoInfo".equals(action)){
			doctorInfo = queryDoctorInfo();
		}
		/*
		 * 查询医生身份证明
		 */
		else if("queryDoctorCardInfo".equals(action)){
			Long dctID = doctorInfo.getId();
		}
		/*
		 * 跳转到签医生页面 
		 */
		else if("initDoctorInfoPage".equals(action)){
			initDoctorInfoPage();
		}
		/*
		 * 要签约的医生信息查询
		 */
		else if("querySignDoctor".equals(action)){
			querySignDoctor();
		}
		mes = "成功";
		return SUCCESS;
	}
	/**
	 * 添加or更新医生评价
	 */
	private void saveOrUpdateDoctorAppraise(){
		DoctorInfo dctInfo = this.queryDoctorInfo();
		dctInfo.setDoctorImpression(doctorInfo.getDoctorImpression());
		doctorRegisterDataGatherService.update(dctInfo);
	}
	/**
	 * 添加or更新医生生活信息 
	 */
	private void saveOrUpdateDoctorLifInfo(){
		DoctorInfo dctInfo = this.queryDoctorInfo();
		doctorLifeInfo.setDoctorInfo(dctInfo);
		super.doctorRegisterDataGatherService.saveOrUpdateDoctorLifeInfo(doctorLifeInfo);
	}
	/**
	 * 要签约的医生信息查询
	 */
	private void querySignDoctor(){
		
	}
	/**
	 * 添加or更新医生基础信息
	 */
	private void saveOrUpdateDoctorBasicInfo(){
		Long dctID = doctorInfo.getId();
		//保存图片
		String uploadImage = uploadImage(dctID, doctorInfo.getDoctorImage(), doctorInfo.getImgBase64());
		doctorInfo.setDoctorImage(uploadImage);
		if(dctID==null){
			//add
			doctorInfo.setOrganOperator(null);
			doctorInfo.setDoctorStatus("N");
			doctorInfo.setAuthentication("未申请");
			doctorInfo.setRegisterTime(DateManage.formatDateStr_yyyy_MM_dd_HH_mm_ss(new Date()));
			doctorInfo.setDoctorPassword(EncryptUtil.getMD5Str("123"));
			super.doctorInfoBo.save(doctorInfo);
			LogUtil.debug("创建注册医生,ID为"+doctorInfo.getId());
		}else{
			//update
			super.doctorInfoBo.update(doctorInfo);
		}
	}
	/**
	 * 添加or更新身份证明
	 */
	private void saveOrUpdateDoctorCardInfo(){
		DoctorInfo dctInfo = this.queryDoctorInfo();
		//保存身份证
		if(StringUtils.isNotBlank(doctorInfo.getIdCardNum())){
			dctInfo.setIdCardNum(doctorInfo.getIdCardNum());
		}
		doctorCardInfo.setDoctorInfo(dctInfo);
		//上传证书图片
		Long cardID = doctorCardInfo.getId();
		String imgPath = doctorCardInfo.getImgPath();
		doctorCardInfo.setImgPath(uploadImage(cardID, imgPath, doctorCardInfo.getImgBase64()));
		doctorRegisterDataGatherService.saveOrUpdateDoctorCardInfo(doctorCardInfo);
	}
	private DoctorInfo queryDoctorInfo(){
		Long dctID = doctorInfo.getId();
		if(dctID==null) throw new RuntimeException("保存注册医生身份信息错误,没有医生ID");
		return doctorRegisterDataGatherService.get(dctID, DoctorInfo.class);
	}
	/**
	 * 跳转到签医生页面 
	 */
	private void initDoctorInfoPage(){
		//医院基本信息
		positionList = doctorIdentifyBo.getAllPosition();//医生职称
		doctorServiceTypes = super.doctorRegisterDataGatherService.getAllDoctorServiceTypes();//医生服务列表
		hospitalBasicInfoList = super.doctorRegisterDataGatherService.getHospitalBasicInfos(null);//医院列表
		firstMajors = super.doctorRegisterDataGatherService.getMajors(major, "first");
		secondMajors = super.doctorRegisterDataGatherService.getMajors(major, "second");
		thirdMajors = super.doctorRegisterDataGatherService.getMajors(major, "third");
	}
	/**
	 * 上传图片
	 * @param id 对象ID 
	 * @param imagePath 已有的图片路径
	 * @param imgBase64 base64编码后的图片
	 * @return
	 */
	private String uploadImage(Long id,String imagePath,String imgBase64){
		String tempDir = "";
		if (id != null && StringUtils.isNotBlank(imagePath)) {
			tempDir = imagePath;
		} else {
			SimpleDateFormat df = new SimpleDateFormat("yyyyMMddhhmmss");
			String current = df.format(new Date());
			String bannerName = "fd" + current + ".jpg";
			tempDir = uploadDir + "/" + bannerName;
			imagePath = tempDir;
		}
		if (StringUtils.isNotBlank(imgBase64)) {
			String directory = ServletActionContext.getServletContext()
					.getRealPath(uploadDir + "/");
			File cacheDir = new File(directory);
			// 如果文件夹不存在则创建
			if (!cacheDir.exists() && !cacheDir.isDirectory()) {
				System.out.println("//不存在");
				cacheDir.mkdirs();
			} else {
				System.out.println("//目录存在");
			}
			// 上传图片
			String dir = ServletActionContext.getServletContext()
					.getRealPath(tempDir);
			try {
				EncryptUtil.uploadImage(imgBase64, dir);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		if(imagePath.indexOf("/")!=-1) imagePath = imagePath.substring(imagePath.lastIndexOf("/")+1);
		return imagePath;
	}
	
	
	
	
	
	
	//----------------setter/getter---------------------------------------
	public DoctorInfo getDoctorInfo() {
		return doctorInfo;
	}
	public DoctorMajor getMajor() {
		return major;
	}
	public void setMajor(DoctorMajor major) {
		this.major = major;
	}
	public String getMes() {
		return mes;
	}
	public void setMes(String mes) {
		this.mes = mes;
	}
	public void setDoctorInfo(DoctorInfo doctorInfo) {
		this.doctorInfo = doctorInfo;
	}
	public DoctorCardInfo getDoctorCardInfo() {
		return doctorCardInfo;
	}
	public void setDoctorCardInfo(DoctorCardInfo doctorCardInfo) {
		this.doctorCardInfo = doctorCardInfo;
	}
	public DoctorLifeInfo getDoctorLifeInfo() {
		return doctorLifeInfo;
	}
	public void setDoctorLifeInfo(DoctorLifeInfo doctorLifeInfo) {
		this.doctorLifeInfo = doctorLifeInfo;
	}
	public HospitalBasicInfo getHospitalBasicInfo() {
		return hospitalBasicInfo;
	}
	public void setHospitalBasicInfo(HospitalBasicInfo hospitalBasicInfo) {
		this.hospitalBasicInfo = hospitalBasicInfo;
	}
	public List<Position> getPositionList() {
		return positionList;
	}
	public void setPositionList(List<Position> positionList) {
		this.positionList = positionList;
	}
	public List<DoctorMajor> getFirstMajors() {
		return firstMajors;
	}
	public void setFirstMajors(List<DoctorMajor> firstMajors) {
		this.firstMajors = firstMajors;
	}
	public List<DoctorMajor> getSecondMajors() {
		return secondMajors;
	}
	public void setSecondMajors(List<DoctorMajor> secondMajors) {
		this.secondMajors = secondMajors;
	}
	public List<DoctorMajor> getThirdMajors() {
		return thirdMajors;
	}
	public void setThirdMajors(List<DoctorMajor> thirdMajors) {
		this.thirdMajors = thirdMajors;
	}
	public List<DoctorServiceType> getDoctorServiceTypes() {
		return doctorServiceTypes;
	}
	public void setDoctorServiceTypes(List<DoctorServiceType> doctorServiceTypes) {
		this.doctorServiceTypes = doctorServiceTypes;
	}
	public List<HospitalBasicInfo> getHospitalBasicInfoList() {
		return hospitalBasicInfoList;
	}
	public void setHospitalBasicInfoList(
			List<HospitalBasicInfo> hospitalBasicInfoList) {
		this.hospitalBasicInfoList = hospitalBasicInfoList;
	}
	public String getUploadDir() {
		return uploadDir;
	}
	public void setUploadDir(String uploadDir) {
		this.uploadDir = uploadDir;
	}
}
