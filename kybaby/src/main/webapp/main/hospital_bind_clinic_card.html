<!doctype html>
<html class="no-js" lang="zh-cn">
<head>
    <title>绑定就诊卡</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/modernizr-2.8.3.min.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/hospital.js"></script>
    <!------------时间控件--------------->
    <script src="js/mobiscroll_002.js" type="text/javascript"></script>
    <script src="js/mobiscroll_004.js" type="text/javascript"></script>
    <link href="js/mobiscroll_002.css" rel="stylesheet" type="text/css">
    <link href="js/mobiscroll.css" rel="stylesheet" type="text/css">
    <script src="js/mobiscroll.js" type="text/javascript"></script>
    <script src="js/mobiscroll_003.js" type="text/javascript"></script>
    <script src="js/mobiscroll_005.js" type="text/javascript"></script>
    <link href="js/mobiscroll_003.css" rel="stylesheet" type="text/css">
    <style>
        .information_div{
            padding: 0 18px;
            height: 55px;
            border-bottom: 1px solid #e8e8e8;
            line-height: 55px;
            overflow: hidden;
        }
        .information_div>label{
            float: left;
            width: 35%;
            display: inline-block;
        }
        .information_div>p,.information_div>ul,#medical_institutions{
            float: left;
            width: 65%;
            display: inline-block;
        }
        .information_div input[type="text"]{
            border: none;
            width: 100%;
            height: 55px;
            line-height: 20px;
            padding: 15px 0;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }
        span#sex_label{
            display: inline-block;
            text-indent: 2em;
        }
        #prompt{
            padding: 18px;
            font-size: 14px;
            color: #909090;
        }
        #baby_sex>li{
            display: inline-block;
            float: left;
            width: auto;
        }
        .selected>.select_option {
            background: #ff813d;
        }
        .select_option {
            background: #fff;
            border: 1px solid #ff813d;
            border-radius: 4px;
            width: 4px;
            height: 4px;
            display: inline-block;
            vertical-align: 2px;
        }
        .select_sex {
            margin: 0 20px 0 15px;
            display: inline-block;
            font-size: 14px;
        }
        #default{
            width: 145px;
            line-height: 55px;
        }
        #last_li{
            padding: 0 18px;
            position: relative;
            border-bottom: 1px solid #f4f4f4;
            overflow: hidden;
        }
        /* Normal Track */
        input[type="checkbox"].ios-switch + div
        {
            vertical-align: middle;
            width: 40px;
            height: 20px;
            border: 1px solid rgba(0,0,0,.4);
            border-radius: 999px;
            background-color: rgba(0, 0, 0, 0.1);
            -webkit-transition-duration: .4s;
            -webkit-transition-property: background-color, box-shadow;
            box-shadow: inset 0 0 0 0px rgba(0,0,0,0.4);
            /*margin: 15px 1.2em 15px 2.5em;*/
        }
        /* Big Track */
        input[type="checkbox"].bigswitch.ios-switch + div
        {
            width: 50px;
            height: 26px;
        }

        /* Green Track */
        input[type="checkbox"].green.ios-switch:checked + div
        {
            background-color: #ff813d;
            border: 1px solid #ff813d;
            box-shadow: inset 0 0 0 10px #ff813d;
        }

        /* Normal Knob */
        input[type="checkbox"].ios-switch + div > div
        {
            float: left;
            width: 18px;
            height: 18px;
            border-radius: inherit;
            background: #ffffff;
            -webkit-transition-timing-function: cubic-bezier(.54,1.85,.5,1);
            -webkit-transition-duration: 0.4s;
            -webkit-transition-property: transform, background-color, box-shadow;
            -moz-transition-timing-function: cubic-bezier(.54,1.85,.5,1);
            -moz-transition-duration: 0.4s;
            -moz-transition-property: transform, background-color;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3), 0px 0px 0 1px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            margin-top: 1px;
            margin-left: 1px;
        }
        /* Big Knob */
        input[type="checkbox"].bigswitch.ios-switch + div > div
        {
            width: 23px;
            height: 23px;
            margin-top: 1px;
        }
        /* Checked Big Knob (Blue Style) */
        input[type="checkbox"].bigswitch.ios-switch:checked + div > div
        {
            -webkit-transform: translate3d(25px, 0, 0);
            -moz-transform: translate3d(16px, 0, 0);
            box-shadow: 0px 4px 8px rgba(255, 129, 61, 0.3), 0px 0px 0 1px #d66666;
        }
        /* Green Knob */
        input[type="checkbox"].green.ios-switch:checked + div > div
        {
            box-shadow: 0px 2px 5px rgba(255, 129, 61, 0.3), 0 0 0 1px #d66666;
        }
        #switch{
            position: absolute;
            right: 12px;
            top: 15px;
        }
        #switch input[type="checkbox"]
        {
            position: absolute;
            opacity: 0;
        }
        #check{
            display: inline-block;
            float: right;
        }
        #checkbox{
            display: inline-block;
            margin-top: 22px;
        }
        #medical_institutions{
            height: 55px;
            border: none;
        }
        #birthDate_div{
            display: none;
        }
    </style>
</head>
<body>

<div id="header">
    <div class="header-left" onclick="return_before();"><span class="color-basic">绑定就诊卡</span></div>
    <div class="header-center"></div>
    <div class="header-right"></div>
</div>
<!--header-->
<div id="container">
    <p class="gray_s"></p>
    <div class="information_div">
        <label>宝宝姓名</label>
        <p><input type="text" id="baby_name" placeholder="宝宝姓名"/></p>
    </div>
    <div class="information_div">
        <label>性<span id="sex_label">别</span></label>
        <!--<p><input type="text" id="sex" placeholder="性别"/></p>-->
        <ul id="baby_sex">
            <li class="selected" id="boy"><span class="select_option" data-sex="1"></span><span class="select_sex">男</span></li>
            <li id="girl"><span class="select_option" data-sex="0"></span><span class="select_sex">女</span></li>
        </ul>
    </div>
    <!--<div class="information_div">-->
    <!--<label>就诊机构</label>-->
    <!--<select id="medical_institutions">-->
    <!--<option data-num="" data-pre="">苏坡社区医院</option>-->
    <!--<option data-num="" data-pre="">第九人民医院</option>-->
    <!--</select>-->
    <!--</div>-->
    <div id="birthDate_div" class="information_div">
        <label id="birthDate">出生日期</label>
        <p><input type="text" class="baby_birthday" placeholder="请选择" readonly="" name="time" id="appDate"></p>
    </div>
    <div class="information_div">
        <label id="id_card">就诊卡号</label>
        <p><input type="text" id="card" placeholder="就诊卡卡号"/></p>
    </div>
    <div id="last_li">
        <label id="default">设为默认就诊人</label>
        <!--<label id="switch"><input type="checkbox" class="ios-switch green bigswitch" checked /><div><div></div></div></label>-->
        <p id="check"><input type="checkbox" id="checkbox"/></p>
    </div>
</div>
<footer id="footer">
    <p class="login_button" onclick="bingCard.bingNewCard()">立即绑定</p>
</footer>

<script>
    var defaultset = 0;
    $(function () {
        bingCard.url=decodeURIComponent(window.location.search.substring(1));
        if(bingCard.url!=''){
            if(bingCard.url!="no_card"){
                bingCard.show();
            }else{
                $("#id_card").text("身份证号");
                $("#last_li").hide();
                $(".login_button").text("确定");
                $("#card").attr("placeholder","身份证号");
                $(".color-basic").text("获取身份信息");
                $("title").text("获取身份信息");
                $("#birthDate_div").show();
            }
        }
        //性别选择
        $("#baby_sex li").click(function(){
            $(this).addClass("selected").siblings("li").removeClass("selected");
        });
        time_plug();
    });
    var bingCard={
        url:decodeURIComponent(window.location.search.substring(1)),
        bingNewCard: function () {
            var card=$('#card').val();
            var sex=$('.selected>.select_sex').text();
            var name = '';
            if($(".login_button").text()=="确定"){
                var names=$('#baby_name').val();
                var id = '';
                var baby_birthday = $("#appDate").val();
                var date_arr = baby_birthday.split('-');
                var dyear = (new Date()).getFullYear();
                var dmonth = (new Date().getMonth())+1;
                var dday = (new Date().getDate());
                var nyear = parseInt(date_arr[0]);
                var nmonth = parseInt(date_arr[1]);
                var nday = parseInt(date_arr[2]);
                if($("#appDate").val()==""){
                    ale("请填写宝宝出生日期");
                    return;
                }else if(nyear > dyear){
                    ale('请选择正确的生日');
                    return false;
                }else if(nyear == dyear && nmonth > dmonth){
                    ale('请选择正确的生日');
                    return false;
                }else if(nyear == dyear && nmonth == dmonth && nday>dday){
                    ale('请选择正确的生日');
                    return false;
                }else{
                    var babyBirthDate = $("#appDate").val();
                }
                if(card=='' || isNaN(card)){
                    ale('请输入身份证号');
                    return false;
                }else if(names==''){
                    ale('请输入姓名');
                    return false;
                }else{
                    hf_loading(true);
                    $.ajax({
                        type:'post',
                        url:spInterfaceService+'registerWithNoCard.action',
                        cache:false,
                        async:true,
                        data:{
                            "spHealthcardManager.identityCard":card,
                            "spHealthcardManager.name ":names,
                            "spHealthcardManager.sex":sex,
                            "spHealthcardManager.birthday":babyBirthDate
                        },
                        success:function(result){
                            hf_loading(false);
                            if(result.mess=="成功"){
                                var url_id = result.spHealthcardManager.residentId;
                                sessionStorage.setItem('spdj','id='+id+',name='+name+',num='+url_id+',names='+names);
                                window.history.go(-2);
                            }else{
                                ale(result.mess);
                            }
                        },
                        error: function (x) {
                            hf_loading(false);
                            layer();
                        }
                    });
                }
            }
            else{
                name = $('#baby_name').val();
                //            var spOrgID = $('#medical_institutions option:selected').data("num");
//            var visitCardPrefix  = $('#medical_institutions option:selected').data("pre");
                if(card=='' || isNaN(card)){
                    ale('请输入就诊卡卡号');
                    return false;
                }else if(name==''){
                    ale('请输入姓名');
                    return false;
                }
//          else if(sex=='' || (sex!="男"&&sex!="女")){
//                ale('请输入正确的性别');
//                return false;
//            }
                if(bingCard.url==''){
                    hf_loading(true);
                    $.ajax({
                        type:'post',
                        url:spInterfaceService+'bindHealthCard.action',
                        cache:false,
                        async:true,
                        data:{
                            "spHealthcardManager.healthcardNum":card,
                            "spHealthcardManager.name":name,
                            "spHealthcardManager.sex":sex,
                            "spHealthcardManager.defaultSet":defaultset,
//                        "spOrgID":spOrgID,
//                        "spHealthcardManager.visitCardPrefix":visitCardPrefix,
                        },
                        success:function(result){
                            hf_loading(false);
                            if(result.mess=="成功"){
                                ale('绑定成功');
                                setTimeout(function () {
                                    return_before();
                                },1000);
                            }else{
                                ale(result.mess);
                            }
                        },
                        error: function (x) {
//                        alert(x.status);
                            hf_loading(false);
                            layer();
                        }
                    });
                }else{//修改
                    hf_loading(true);
                    if($("#checkbox").prop("checked")==false){
                        defaultset = 0;
                    }else{
                        defaultset = 1;
                    }
                    $.ajax({
                        type:'post',
                        url:spInterfaceService+'setHealthCardOfUserUsed.action',
                        cache:false,
                        async:true,
                        data:{
                            "spHealthcardManager.healthcardNum":card,
                            "spHealthcardManager.name":name,
                            "spHealthcardManager.sex":sex,
                            "spHealthcardManager.id":bingCard.url,
                            "spHealthcardManager.defaultSet":defaultset
                        },
                        success:function(result){
                            hf_loading(false);
                            if(result.mess=="成功"){
                                ale('修改成功');
//                            $('#card').attr("readOnly","false");
                                setTimeout(function () {
                                    return_before();
                                },1000);
                            }else{
                                ale(result.mess);
                            }
                        },
                        error: function (x) {
//                        alert(x.status);
                            hf_loading(false);
                            layer();
                        }
                    });
                }
            }
        },
        show: function () {//修改显示
            hf_loading(true);
            $.ajax({
                type:'post',
                url:spInterfaceService+'queryHealthCardOfUserOwned.action',
                cache:false,
                async:true,
                data:{},
                success:function(result){
                    hf_loading(false);
                    if(result.mess=="成功"){
                        var reqData=result.healthCardOfUserOwneds;
                        if(reqData=='' || reqData.length==0 || reqData==null){

                        }else{
                            for(var i= 0,len=reqData.length;i<len;i++){
                                if(bingCard.url==reqData[i].id){
                                    $('title,.header-left>span').html('修改就诊卡信息');
                                    $('footer p').html('修改');
                                    $('#card').val(reqData[i].healthcardNum);
                                    $('#baby_name').val(reqData[i].name);
                                    if(reqData[i].sex=="男"){
                                        $("#boy").addClass("selected");
                                    }else{
                                        $("#girl").addClass("selected");
                                        $("#boy").removeClass("selected");
                                    }
                                    if(reqData[i].defaultSet=="0"){
                                        $("#checkbox").prop("checked",false);
                                    }else{
                                        $("#checkbox").prop("checked",true);
                                    }
                                    return false;
                                }
                            }
                        }
                    }
                },
                error: function (x) {
                    hf_loading(false);
                    layer();
//                    alert(x.status);
                }
            });
        }
    }
    /*****************     日期插件BEGIN     *****************/
    function time_plug(){
        var currYear = (new Date()).getFullYear();
        var opt = {};
        opt.date = {preset: 'date'};
        opt.datetime = {preset: 'datetime'};
        opt.time = {preset: 'time'};
        opt.default = {
            theme: 'android-ics light', //皮肤样式
            display: 'modal', //显示方式
            mode: 'scroller', //日期选择模式
            dateFormat: 'yyyy-mm-dd',
            lang: 'zh',
            showNow: true,
            nowText: "今天",
            startYear: currYear - 50, //开始年份
            endYear: currYear//结束年份
        };

        $("#appDate").mobiscroll($.extend(opt['date'], opt['default']));
        var optDateTime = $.extend(opt['datetime'], opt['default']);
        var optTime = $.extend(opt['time'], opt['default']);
//		$("#appDate").mobiscroll(optDateTime).datetime(optDateTime);
//		 $("#appTime").mobiscroll(optTime).time(optTime);
    }
    /*****************     日期插件END     *****************/
</script>
</body>
</html>
