<!doctype html>
<html class="no-js" lang="zh-cn">
<head>
    <title>商城订单</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1"/>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/swiper-3.3.1.min.css"/>
    <link rel="stylesheet" href="css/mall.css"/>
    <script src="js/modernizr-2.8.3.min.js"></script>
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/config.js"></script>
    <script src="js/swiper-3.3.1.jquery.min.js"></script>
    <style>
        nav{
            position: fixed;
            left: 0;
            right: 0;
            z-index: 111;
            border-top: 1px solid #e8e8e8;
            top: 93px;
        }
        nav>ul,.order_item>div{
            display: -webkit-box;
            display: -moz-box;
            display: -ms-box;
            display: -o-box;
            display: box;
            background: #fff;
            border-bottom: 1px solid #e8e8e8;
        }
        nav>ul>li{
            -webkit-box-flex: 1;
            -moz-box-flex: 1;
            -ms-box-flex: 1;
            -o-box-flex: 1;
            box-flex: 1;
            height: 45px;
            line-height: 45px;
            text-align: center;
            font-size: 15px;
        }
        nav>ul>li.cur {
            border-bottom: 2px solid #d66666;
            box-sizing: border-box;
            color: #d66666;
        }
        .order_item>div{
            padding: 5px 12px;
        }
        .order_div1{
            line-height: 30px;
            font-size: 15px;
        }
        .order_id{
            -webkit-box-flex: 7;
            -moz-box-flex: 7;
            -ms-box-flex: 7;
            -o-box-flex: 7;
            box-flex: 7;
        }
        .order_type{
            -webkit-box-flex: 3;
            -moz-box-flex: 3;
            -ms-box-flex: 3;
            -o-box-flex: 3;
            box-flex: 3;
            text-align: right;
            color: #d66666;
        }
        .order_div2 .item_img img {
            width: 100%;
            height: 100%;
            transform: translateZ(0);
        }
        .item_img {
            width: 60px;
            height: 60px;
            margin: 8px 12px 0 0;
            overflow: hidden;
            -webkit-box-pack: center;
            -moz-box-pack: center;
            -ms-box-pack: center;
            -o-box-pack: center;
            box-pack: center;
            -webkit-box-align: center;
            -moz-box-align: center;
            -ms-box-align: center;
            -o-box-align: center;
            box-align: center;
            display: -webkit-box;
            display: -moz-box;
            display: -ms-box;
            display: -o-box;
            display: box;
            background: #fff;
            overflow: hidden;
        }
        .product_name{
            overflow: hidden;
            -webkit-line-clamp: 2;
            -moz-line-clamp: 2;
            -ms-line-clamp: 2;
            -o-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            -moz-box-orient: vertical;
            -ms-box-orient: vertical;
            -o-box-orient: vertical;
            box-orient: vertical;
            display: -webkit-box;
            display: -moz-box;
            display: -ms-box;
            display: -o-box;
            display: box;
            word-break: break-all;
            font-size: 14px;
        }
        .product_price>span{
            font-size: 13px;
            margin-left: 20px;
        }
        .cont{
            -webkit-box-flex: 4;
            -moz-box-flex: 4;
            -ms-box-flex: 4;
            -o-box-flex: 4;
            box-flex: 4;
            line-height: 35px;
        }
        .cont>span{
            color: #d66666;
        }
        .button_list{
            -webkit-box-flex: 6;
            -moz-box-flex: 6;
            -ms-box-flex: 6;
            -o-box-flex: 6;
            box-flex: 6;
            overflow: hidden;
        }
        .cont_button{
            float: right;
            text-align: center;
            background: #fff;
            border: 1px solid #000;
            outline: none;
            font-size: 15px;
            padding: 5px 10px;
            margin: 5px 0 5px 6px;
        }
        .order_list{
            display: none;
            margin-top: 90px;
        }
        #all_order{
            display: block;
        }
        span{
            display: inline-block;
        }
        p.gray_1{
            height: 5px;
        }
    </style>
    <style>
        .head_nav{
            overflow: hidden;
            padding: 12px 0;
            background: #d66666;
            position: fixed;
            left: 0;
            top: 45px;
            z-index: 111;
            width: 100%;
        }
        .head_nav>div{
            float:left;
            width:50%;
            box-sizing:border-box;
            -moz-box-sizing:border-box; /* Firefox */
            -webkit-box-sizing:border-box; /* Safari */
            text-align: center;
            color: #fff;
            font-size: 15px;
        }
        .head_nav>div>span{
            padding-left: 6px;
            padding-right: 6px;
        }
        .leftmeu{
            border-right: 1px solid #fff;
        }
        .select>span{
            padding-bottom: 2px;
            border-bottom: 1px solid #fff;
        }
    </style>
</head>
<body>

<div id="header">
    <div class="header-left"><span>商城订单</span></div>
    <div class="header-center"></div>
    <div class="header-right"></div>
</div>
<!--header-->
<div id="container">
    <div class="head_nav">
        <div data-name="商品订单" class="selbtn leftmeu"><span>商品订单</span></div>
        <div data-name="服务订单" class="selbtn rightmeu select"><span>服务订单</span></div>
    </div>
    <nav>
        <ul>
            <li class="cur">全部</li>
            <li>待付款</li>
            <li>已付款</li>
            <!--<li>已发货</li>-->
            <!--<li>待评价</li>-->
        </ul>
    </nav>
    <section class="order_list" id="all_order">
        <!--<p class="gray_1"></p>-->
        <!--<div class="order_item">-->
        <!--<div class="order_div1">-->
        <!--<p class="order_id">订单号：E2567415214745</p>-->
        <!--<p class="order_type">待付款</p>-->
        <!--</div>-->
        <!--<div class="order_div2">-->
        <!--<div class="item_img">-->
        <!--<p><img src="images/adminManage.jpg"/></p>-->
        <!--</div>-->
        <!--<div class="product_content">-->
        <!--<p class="product_name">良品铺子猪肉脯小包装零食小吃肉干肉脯猪肉干猪肉铺蜜汁休闲食品良品铺子猪肉脯小包装零食小吃肉干肉脯猪肉干猪肉铺蜜汁休闲食品</p>-->
        <!--<p class="product_specifications"><span>红色</span><span>XL</span></p>-->
        <!--<p class="product_price">￥32.00 <span>×1</span></p>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="order_div3">-->
        <!--<p class="cont">总价：<span>￥64.00</span></p>-->
        <!--<p class="button_list"><button class="cont_button">去付款</button><button class="cont_button">取消订单</button></p>-->
        <!--</div>-->
        <!--</div>-->
    </section>
    <section class="order_list" id="payment"></section>
    <section class="order_list" id="delivery_before"></section>
    <section class="order_list" id="delivery_after"></section>
    <!--<section class="order_list" id="evaluation"></section>-->
</div>
<script language="javascript">

</script>
<script src="js/main.js"></script>
<script src="js/plugins.js"></script>
<script>
    $(function(){
        $(".header-left").click(function(){
            window.location.href = 'personalcenter.html';
            sessionStorage.setItem('server_order','');
        })
        $(".head_nav .leftmeu").click(function(){
            window.location.href = 'mall_order_list.html';
            sessionStorage.setItem('server_order','');
        })
        $("nav ul li").click(function(){
            $(this).addClass("cur").siblings().removeClass("cur");
            var id = $(this).index();
            $(".order_list").eq(id).show().siblings(".order_list").hide();
            sessionStorage.setItem('server_order',$(this).text());
        })
        $.ajax({
            type: 'post',
            url: mall + 'goodsOrderManage.action',
            cache: false,
            async: true,
            data:  {action: "getB2cGoodsOrderList"},
            success: function (result) {
                if(result.mes=='请登录'){
                    ale('请登录', '24px');
                    window.location.href = "login.html";
                }
                else if(result.mes=='成功'){
                    if(result.b2cGoodsOrderList!=null){
                        for(var i=0;i<result.b2cGoodsOrderList.length;i++){
                            var order_list = result.b2cGoodsOrderList[i];
                            if(order_list.b2cGoodsOrderDetailSet.length>0){
                                var order_set = order_list.b2cGoodsOrderDetailSet[0];
                                if(order_set.b2cGoods.b2cGoodsType.typeName=='健康服务'||order_set.b2cGoods.b2cGoodsType.typeName=='健康测评'){
                                    var propVals='';
                                    var button_list = '';
                                    if(order_set.propVals!=null){
                                        propVals=order_set.propVals;
                                    }
                                    if(order_set.b2cGoods.b2cGoodsType.typeName=='健康测评'){
                                        if(order_list.orderStatus=='未付款'){
                                            button_list ='<button class="color_button">去付款</button>';
                                        }else if(order_list.orderStatus=='已付款'){
                                            button_list ='<button class="look_button">看结果</button><button class="measure_button" data-id="'+order_set.b2cGoods.goodsSn+'">去测评</button>';
                                        }
                                    }else{
                                        if(order_list.orderStatus=='未付款'){
                                            button_list ='<button class="del_button">删除订单</button><button class="measure_button">去付款</button>';
                                        }else if(order_list.orderStatus=='已付款'){
                                            button_list ='<button class="del_button" style="display: none">取消订单</button>';
                                        }else if(order_list.orderStatus=='预付款'){
                                            button_list ='<button class="del_button" style="display: none">取消订单</button><button class="color_button">付尾款</button>';
                                        }
                                    }
                                    var totalPrice='',postage='';
                                    if(order_list.postage!=null){
                                        postage='运费：&yen;'+parseFloat(order_list.postage).toFixed(2);
                                        totalPrice=parseFloat(parseFloat(order_set.price).toFixed(2)*parseInt(order_set.goodsNum)+parseInt(order_list.postage)).toFixed(2);
                                    }else{
                                        totalPrice=parseFloat(parseFloat(order_set.price).toFixed(2)*parseInt(order_set.goodsNum)).toFixed(2);
                                    }
                                    var html_txt = '<p class="gray_1"></p><div class="order_item" data-id="'+order_list.id+'"><div class="order_div1 order_available"><p class="order_id">订单号：'+order_list.orderNum+'</p>' +
                                            '<p class="order_type">'+order_list.orderStatus+'</p></div><div class="order_div2 order_available"><div class="item_img"><img src="'+photo+order_set.b2cGoods.goodsImg+'"/></div>' +
                                            '<div class="product_content"><p class="product_name">'+order_set.b2cGoods.goodsName+'</p><p class="product_specifications"><span>'+propVals+'</span><span class="number">剩余:'+order_list.surplusCount+'次</span></p>' +
                                            '<p class="product_price">￥'+parseFloat(order_set.price).toFixed(2)+'<small>×'+order_set.goodsNum+'</small><span style="display: none">'+postage+'</span></p></div></div><div class="order_div3"><p class="cont">总价：' +
                                            '<span>￥'+totalPrice+'</span></p><p class="address_button">'+button_list+'</p></div></div>';
                                    $("#all_order").append(html_txt);
                                    if(order_list.orderStatus=="未付款"){
                                        $("#payment").append(html_txt);
                                    }else if(order_list.orderStatus=="已付款"){
                                        $("#delivery_before").append(html_txt);
                                    }else if(order_list.orderStatus=="已发货"){
                                        $("#delivery_after").append(html_txt);
                                    }
                                }
                            }
                        }
                        $(".order_available").click(function () {
                            var id = $(this).parent(".order_item").data('id');
                        $(".color_button").click(function () {
                            if($(this).text()=="去付款" || $(this).text()=="付尾款"){
                                var id = $(this).parents(".order_item").data('id');
                                link_to('mall_service_order_confirm.html?'+id);
                                link_to('mall_service_order_details.html?'+id);
                            })
                            }
                        })
                        $(".look_button").click(function () {//看结果
                            var order_id = $(this).parents(".order_item").data("id");
                            link_to('evaluate_evaluateResults.html?order='+order_id);
                        })
                        $(".measure_button").click(function () {//去测评
                            var order_id = $(this).parents(".order_item").data("id");
                            var goodSn = $(this).data("id");
                            $.ajax({
                                type: 'post',
                                url: testManager + 'asqAction.action',
                                cache: false,
                                async: true,
                                data:  {action: "checkCountisOver",
                                    "b2cGoodsOrder.id" : order_id,
                                },
                                success: function (result) {
                                    if(result.mes=='请登录'){
                                        ale('请登录', '24px');
                                        window.location.href = "login.html";
                                    }
                                    else if(result.mes=='成功'){
                                        link_to('evaluate_fd_assessment_information.html?order='+order_id+"&goodSn="+goodSn);
                                    }else if(result.mes!='成功'){
                                        ale(result.mes);
                                    }
                                },
                                error: function () {
                                    layer();
                                }
                            });
                        })
                        $(".del_button").click(function(){
                            var answer=confirm('你确定要'+$(this).text()+'吗？');
                            if(answer==false){
                                return false;
                            }
                            var id = $(this).parents(".order_item").data('id');
                            var orderStatus = '';
                            if($(this).text()=='取消订单'){
                                orderStatus = "cancle";
                                return false;
                            }else if($(this).text()=='删除订单'){
                                orderStatus = "delete";
                            }
                            $.ajax({
                                type: 'post',
                                url: mall + 'goodsOrderManage.action',
                                cache: false,
                                async: true,
                                data:  {action: "handleB2cGoodsOrder",
                                    "b2cGoodsOrder.totalPrice":'',
                                    "b2cGoodsOrder.realPrice":'',
                                    "b2cGoodsOrder.useRemainBalance":'',
                                    "b2cGoodsOrder.payMethod":'',
                                    "b2cGoodsOrder.baddress":'',
                                    "b2cGoodsOrder.bconsignee":'',
                                    "b2cGoodsOrder.bphone":'',
                                    "b2cGoodsOrder.postage":'',
                                    "b2cGoodsOrder.id":id,
                                    "b2cGoodsOrder.orderStatus":orderStatus,
                                    "b2cGoodsOrderDetail.b2cGoods.id":'',
                                    "b2cGoodsOrderDetail.goodsNum":'',
                                    "b2cGoodsOrderDetail.propVals":''
                                },
                                success: function (result) {
                                    if(result.mes=='请登录'){
                                        ale('请登录', '24px');
                                        window.location.href = "login.html";
                                    }
                                    else if(result.mes=='成功'){
                                        window.location.href='mall_service_order_list.html';
                                    }else if(result.mes!='成功'){
                                        ale(result.mes);
                                    }
                                },
                                error: function () {
                                    layer();
                                }
                            });
                        })
                    }
                }
            },
            error: function () {
                layer();
            }
        });
        var session=sessionStorage.getItem('server_order');
        for(var i=0;i<$("nav ul li").length;i++){
            if($("nav ul li").eq(i).text()==session){
                $("nav ul li").eq(i).trigger("click");
                sessionStorage.setItem('server_order',$("nav ul li").eq(i).text());
            }
        }
    })
</script>
</body>
</html>